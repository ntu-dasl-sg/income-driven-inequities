library(readr)
library(dplyr)
library(tidyverse)

# Read in damage functions
df_I <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class1_dmg_fn.csv"
df_II <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class2_dmg_fn.csv"
df_IIa <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class2a_dmg_fn.csv"
df_IIb <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class2b_dmg_fn.csv"
df_IIIa <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class3a_dmg_fn.csv"
df_IIIb <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class3b_dmg_fn.csv"
df_IVa <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class4a_dmg_fn.csv"
df_IVb <- "D:/Jeanette/00_Data/Damage-depth function/englhardt_class4b_dmg_fn.csv"
df_JRC <- "D:/Jeanette/00_Data/Damage-depth function/global_dmgfn_res.csv"

# Function to open damage function & interpolate values
open_damage_function <- function(df_file){ # opens the damage function file and interpolates between values
  df <- read.csv(file = df_file)
  df_interp <- approx(unlist(df[1]), unlist(df[2]), seq(0, 10, by = 0.01)) # df[1]=wd, #df[2]=damagefrac
  return(as.data.frame(df_interp)) # returns damage fractions
}

# open dfs and interpolate between values
df_I <- open_damage_function(df_I)
df_II <- open_damage_function(df_II)
df_IIa <- open_damage_function(df_IIa)
df_IIb <- open_damage_function(df_IIb)
df_IIIa <- open_damage_function(df_IIIa)
df_IIIb <- open_damage_function(df_IIIb)
df_IVa<- open_damage_function(df_IVa)
df_IVb <- open_damage_function(df_IVb)
df_JRC <- open_damage_function(df_JRC)



colnames(df_I) <- c("depth", "df")
colnames(df_II) <- c("depth", "df")
colnames(df_IIa) <- c("depth", "df")
colnames(df_IIb) <- c("depth", "df")
colnames(df_IIIa) <- c("depth", "df")
colnames(df_IIIb) <- c("depth", "df")
colnames(df_IVa) <- c("depth", "df")
colnames(df_IVb) <- c("depth", "df")
colnames(df_JRC) <- c("depth", "df")



combined_df <- merge(df_I, df_II, by="depth")
combined_df <- merge(combined_df, df_IIa, by="depth")
combined_df <- merge(combined_df, df_IIb, by="depth")
combined_df <- merge(combined_df, df_IIIa, by="depth")
combined_df <- merge(combined_df, df_IIIb, by="depth")
combined_df <- merge(combined_df, df_IVa, by="depth")
combined_df <- merge(combined_df, df_IVb, by="depth")
combined_df <- merge(combined_df, df_JRC, by="depth")


colnames(combined_df) <- c("depth", "I", "II","IIa","IIb","IIIa", "IIIb", "IVa", "IVb", "JRC")

# write to file 
# write.csv(combined_df, file="/Users/jeancjw/Documents/00_Data/Damage-depth function/all_dmg_fn.csv")


# Generate curves for different income groups
## Read income weights
weights <- read_csv("D:/Jeanette/00_Data/Damage-depth function/income_weights.csv")

low_weights <- weights$low
middle_weights <- weights$middle
high_weights <- weights$high

combined_df <- combined_df %>% 
  mutate(low_income=low_weights[1]*combined_df$I + low_weights[2]*combined_df$II + low_weights[3]*combined_df$IIa + low_weights[4]*combined_df$IIb + low_weights[5]*combined_df$IIIa + low_weights[6]*combined_df$IIIb + low_weights[7]*combined_df$IVa + low_weights[8]*combined_df$IVb) %>% 
  mutate(middle_income=middle_weights[1]*combined_df$I + middle_weights[2]*combined_df$II + middle_weights[3]*combined_df$IIa + middle_weights[4]*combined_df$IIb+ middle_weights[5]*combined_df$IIIa + middle_weights[6]*combined_df$IIIb + middle_weights[7]*combined_df$IVa + middle_weights[8]*combined_df$IVb) %>% 
  mutate(high_income=high_weights[1]*combined_df$I + high_weights[2]*combined_df$II + high_weights[3]*combined_df$IIa + high_weights[4]*combined_df$IIb + high_weights[5]*combined_df$IIIa + high_weights[6]*combined_df$IIIb + high_weights[7]*combined_df$IVa + high_weights[8]*combined_df$IVb)


# Create new data frame for plotting
df_low <- combined_df %>% 
  select(depth, low_income) %>% 
  rename("df" = "low_income") %>% 
  mutate(cat = rep("Low income", nrow(combined_df)))

# write_csv(df_low, file ="D:/Jeanette/00_Data/Damage-depth function/dmg_fn_low.csv")


df_mid <- combinedfile = df_mid <- combined_df %>% 
  select(depth, middle_income) %>% 
  rename("df" = "middle_income") %>% 
  mutate(cat = rep("Middle income", nrow(combined_df)))
# write_csv(df_mid, file ="D:/Jeanette/00_Data/Damage-depth function/dmg_fn_mid.csv")

df_high <- combined_df %>% 
  select(depth, high_income) %>% 
  rename("df" = "high_income") %>% 
  mutate(cat = rep("High income", nrow(combined_df)))
# write_csv(df_high, file ="D:/Jeanette/00_Data/Damage-depth function/dmg_fn_high.csv")

df_JRC <- combined_df %>% 
  select(depth, JRC) %>% 
  rename("df" = "JRC") %>% 
  mutate(cat = rep("Huizinga et al. (2017)", nrow(combined_df)))


# combine them in long form
df_incomes <- rbind(df_low, df_mid, df_high, df_JRC)

df_incomes <- df_incomes %>% 
  mutate(cat = factor(cat, levels = c("Low income", "Middle income", "High income", "Huizinga et al. (2017)")))


# Plot curves
dmg_fn <- ggplot(df_incomes, aes(x = depth, y = df, linetype = cat)) +
  geom_line()+
  labs(x = "Flood depth (m)", y = "Damage Fraction", linetype = "Vulnerability curve") +
  scale_linetype_manual(values =c("Low income" = "dotted", "Middle income" = "dashed", "High income"= "longdash", "Huizinga et al. (2017)"="solid"))+
  theme_bw() + 
  xlim(0,6) + 
  ylim(0,1)

ggsave(filename="D:/Jeanette/03_Results/Figures/Paper/dmg-depth.png", dpi=300, height = 5, width=8)
