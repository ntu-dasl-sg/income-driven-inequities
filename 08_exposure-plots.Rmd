---
title: "Exposure plots"
output: html_document
date: "2024-05-13"
---


```{r Setup, include=FALSE}
library(raster)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(data.table)
library(wacolors)
```

## 1. LOAD DATA 

```{r read RDS}
data20 <- rbindlist(readRDS("D:/Jeanette/02_Code/08_DATA20_buffer_1k.rds")) # from 'exposure-setup.R', for year 2020 (baseline)
data50 <- rbindlist(readRDS("D:/Jeanette/02_Code/08_DATA50_buffer_1k.rds")) # from 'exposure-setup.R', for year 2050 (with sea level rise)

# data20$year <-"2020"
# data50$year <-"2050"

# Create combined df
data_ALL <- rbind(data50, data20)


data_ALL <- bind_rows(
  mutate(data_ALL %>% filter(year == 2020),
         year = factor(year),
         color = "darkgrey"),  # Color for 2020
  mutate(data_ALL %>% filter(year == 2050),
         year = factor(year),
         color = "#294475")  # Color for 2050
)

data_ALL %>% arrange(-income)
```

## 1.1 Poverty categories

Income is categorised into two groups - above and below the international poverty line (US$2.15 per person per day 2017 PPP) as defined by the World Bank. We convert this value to a household-level poverty line, assuming that a household has five members on average (defined by the Philippine Statistics Authority in their national poverty threshold).


```{r}
# Get international poverty line (see:)
pov_line <- 47.8 * 5 * 365 / 1000 # US$2.15 per person per day [2017 prices] converted to '000 PHP per household per year
nat_pov_line <- 12030*12/1000 # almost equivalent to the lower middle income class international pov line 

low_mid_pov_line <- 81.2 * 5 /1000 * 365# # low-middle income class poverty line US$3.65 /person/day converted to PHP per person per year
upp_mid_pov_line <- 152.4 * 5 /1000 * 365# # upper-middle income class poverty line US$ 6.85/person/day converted to PHP per person per year
```

First, we find out how many households within the 1km buffer live under the poverty threshold.

```{r}
data20 %>% 
  filter(!is.na(income)) %>% 
  filter(depth > 0) %>% 
  mutate(income_category = ifelse(income <= pov_line, "Below poverty line", "Above poverty line")) %>% 
  filter(income_category == "Below poverty line")

```

Results show that:
176,786 households (9.2%) live below the poverty line within the 1km buffer (87235PHP) |283,834 (2km) |538,823 (5km)
993,550 households (51.9%) live below the low-mid pov line within the 1km buffer (148190PHP) |  1,583,274 (2km) |2,595,797 (5km)
1,582,113 households (82.7%) live below the upper-mid pov line within the 1km buffer (278000PHP) | 2,576,148 (2km) | 4,191,590 (5km)

Total hh 1,913,831 (1km); 5,022,318 (5km)

```{r}
# 1km
176786/1913831 # 9.2% # extreme/int'l
993550/1913831 # 51.9% # low mid
1582113/1913831 # 82.7% # upp mid
973231/1913831# 50.85% # national

# 2km
283834/3125521 # 9.08%
158274/3125521 # 50.6%
2576148/3125521 # 82.4%

# 5km
538823/5022318 # 10.7%
2595797/5022318 # 51.6%
4191590/5022318 # 83.5%
```

Do the same for 2050
```{r}
data50 %>% 
  filter(!is.na(income)) %>% 
  mutate(income_category = ifelse(income <= pov_line, "Below poverty line", "Above poverty line")) %>% 
  filter(income_category == "Below poverty line")

```

```{r}
# below national pov line
973231/1913831 # 50.85%

# below international pov line
176786/1913831 # 9.24%

```

Find percentage of people exposed to extreme poverty who are exposed to flooding.

```{r}
data50 %>% 
  filter(!is.na(income)) %>%  mutate(exposure_level = ifelse(depth == 0, "None",
                                                             ifelse(depth > 0 & depth <= 15, "Low (≤ 15cm)",
                                                                    ifelse(depth > 15 & depth <= 50, "Moderate (15 - 50cm)",
                                                                           ifelse(depth > 50 & depth <= 150, "High (50 - 150cm)",
                                                                                  ifelse(depth > 150, "Very high (> 150cm)", NA)))))) %>% 
  mutate(income_category = ifelse(income <= pov_line, "Below poverty line", "Above poverty line")) %>% 
  filter(income_category == "Above poverty line") %>% 
  filter(exposure_level=="None")
# filter(exposure_level=="Low (≤ 15cm)")
# filter(exposure_level=="Moderate (15 - 50cm)")
# filter(exposure_level=="High (50 - 150cm)")
# filter(exposure_level=="Very high (> 150cm)")
```

```{r 2050}
# below pov line (intl)
536/176786 * 100 # 0.3% Low
920/176786 * 100 #0.5204032
1237/176786 * 100 #0.699716
2681/176786 * 100 # 1.516523 V High
171412/176786 * 100 #96.96017 None

# below national pov line
3784 /973231 * 100 # 0.389% Low
6694/973231 * 100 #0.688%
10231/973231 * 100 # 1.051241%
14949/973231 * 100 # 1.536018 V high
937573/973231 * 100 # 96.33612 None

# above pov line
6726/1737045*100 # low
12247/1737045*100 # mod
16599/1737045*100 # high
20244/1737045*100 # v high
1681229/1737045*100 # none

# above nat pov line
3478/1681229*100 # 0.2068725 # Low
6473/1681229*100 # mod
7605/1681229*100 # high
7976/1681229 *100 # v high
915068/1681229 *100# none

```

Here we see that even within the 1km buffer, most households living under poverty are not exposed. This is unsurprising considering we are only accounting for coastal flooding, and not other hazards such as typhoons that tend to coincide with coastal flooding. 

```{r}
# manipulate data
data_ALL <- data_ALL%>% 
  filter(!is.na(income)) %>%
  mutate(income_category = ifelse(income <= pov_line, "Below poverty line", "Above poverty line")) %>% 
  mutate(income_bot20 = ifelse(income <= quantile(income, 0.2, na.rm = T), "Bottom 20%", "Rest of households")) %>% 
  mutate(income_quantile = ifelse(income <= quantile(income, 0.2, na.rm = TRUE), "Bottom 20%",
                                             ifelse(income <= quantile(income, 0.4, na.rm = TRUE), "Q2", 
                                                    ifelse(income <= quantile(income, 0.6, na.rm = TRUE), "Q3",
                                                           ifelse(income <= quantile(income, 0.8, na.rm = TRUE), "Q4", "Top 20%")))))


data_ALL <- data_ALL %>% 
  mutate(income_category_nat = ifelse(income <=nat_pov_line, "Below poverty line", "Above poverty line"))
```


## 1. Cumulative distributions

Despite a small percentage of the population exposed to coastal flooding, there are still disparities in exposure between income groups. We demonstrate this in the following sections. 

### 1.1 Exposed vs not

Just by observing the distribution of household incomes of those exposed versus those not exposed to coastal flooding, we see that a larger proportion of those exposed tend to be low-income households, as compared to those who are not exposed.

```{r}
data_ALL %>% 
  mutate(exposure = ifelse(depth > 0, "Exposed", "Not exposed")) %>% 
  filter(year == "2050") %>% 
  ggplot(aes(x=income, linetype = exposure))+
geom_smooth(stat="ecdf", se=F, size=0.6, color="black")+
  # geom_vline(xintercept =pov_line, color="#3477eb", size=0.5, linetype="dotted")+
    # annotate("text", x =pov_line, y = Inf, label = "Poverty line", vjust = -0.3, hjust =1.1, angle = 90, size=3.5, color="#3477eb") +
  theme_bw()+
  scale_linetype_manual(values=c("Exposed" = "solid", "Not exposed"="dashed"))+
  labs(x="Avg household income ('000 PHP/yr)",
       y= "Frequency", 
       color= "Poverty line",
       linetype = "Exposure") + 
  xlim(0,750)
```


We also need to consider the flood depths to which households are exposed. Are low-income households more exposed to higher flood depths?


```{r}
# Set color palette for different flood exposure levels
# Flood exposure levels were obtained from Rentschler et al. (2022) 'Flood exposure and poverty in 188 countries'
color_palette <- c("None" = "grey", "Low (≤ 15cm)" = "#92c5de", "Moderate (15 - 50cm)" = "#4393C3", "High (50 - 150cm)" = "#0e33a1", "Very high (> 150cm)" = "black")

# Categorise flood exposure levels

data_ALL <- data_ALL %>%
  mutate(exposure_level = ifelse(depth == 0, "None",                                              ifelse(depth > 0 & depth <= 15, "Low (≤ 15cm)",                                                     ifelse(depth > 15 & depth <= 50, "Moderate (15 - 50cm)", ifelse(depth > 50 & depth <= 150, "High (50 - 150cm)",ifelse(depth > 150, "Very high (> 150cm)", NA)))))) %>% 
  mutate(exposure_level = factor(exposure_level, levels = c("None", "Low (≤ 15cm)", "Moderate (15 - 50cm)", "High (50 - 150cm)", "Very high (> 150cm)")))

data_ALL

```




### 1.2 Exposure levels CDF
```{r fig.width=7.5, fig.height=5}
data_ALL %>%
  filter(year == "2020") %>%
   # filter(exposure_level %in% c("Low (≤ 15cm)","Very high (> 150cm)")) %>% 
  # filter(exposure_level %in% c("Low (≤ 15cm)","High (50 - 150cm)")) %>%
    # filter(exposure_level %in% c("Low (≤ 15cm)","Moderate (15 - 50cm)")) %>%
  # filter(depth > 0) %>% 
  # filter(exposure_level=="None") %>%
  ggplot(aes(x = income, color = exposure_level)) +
           geom_smooth(stat = "ecdf",
                       method = "loess",
                       se = FALSE,
                       size=0.5,
                       adjust=10) +
           # scale_color_manual(values = c("2020"="darkorange", "2050"="black")) +
  scale_color_manual(values = color_palette) +
           theme_bw() +
  theme(panel.grid.major=element_line(color="grey93", size=0.25),
        panel.grid.minor=element_line(color="grey93", size=0.25)) +
           labs(x = "Household income ('000 PHP/year)",
                y = "Cumulative frequency",
                color = "Exposure level") +
           scale_x_continuous(breaks = seq(0, 800, by = 200), limits = c(0, 800), expand=c(0,0))

# ggsave(plot = last_plot(),
#        dpi=300, 
#        height=5.5,
#        width =7.5,
#        filename = "D:/Jeanette/03_Results/Figures/Paper/Exposure/01b_CDF_flood_2020.png")


```
### 1.3 Inequity in exposure

#### 1.3.1 Pov line
```{r}
data_ALL 
```

Inequity in exposure in 2020 and 2050 (with sea level rise)

```{r}
data_ALL %>%   
  filter(!is.na(income)) %>% 
  filter(year == "2020") %>% 
  # filter(depth > 0 & depth < 400) %>%
  filter(depth < 400) %>%
  mutate(income_category = ifelse(income <= poverty_line, "Below poverty line", "Above poverty line")) %>%
  ggplot(aes(x=depth, 
             linetype = income_category))+
  geom_smooth(stat="ecdf", method = "loess", se=F, size =0.5, colour = "black") +
  labs(x = "Flood depth (cm)", 
       y = "Cumulative frequency",
       color = "Year",
       linetype = "Income category") + 
  # scale_color_manual(values = c("#bdb8ad","#44749D")) +
  scale_linetype_manual(values = c("Below poverty line" = "dashed", "Above poverty line" = "solid")) +
  theme_bw()+
  theme(panel.grid.major=element_line(color="grey93"),
        panel.grid.minor=element_line(color="grey93")) +
  scale_x_continuous(limits = c(0,400), expand=c(0,0)) +
  ylim(0.965,1) +
  facet_wrap(~year, scales = "fixed")
```

Plot both together:
```{r}
data_ALL %>%   
  filter(!is.na(income)) %>% 
  # filter(depth > 0 & depth < 400) %>%
  filter(depth < 400) %>%
  mutate(income_category = ifelse(income <= poverty_line, "Below poverty line", "Above poverty line")) %>%
  ggplot(aes(x=depth, 
             color = year, 
             linetype = income_category))+
  geom_smooth(stat="ecdf", method = "loess", se=F, size =0.5) +
  labs(x = "Flood depth (cm)", 
       y = "Cumulative frequency",
       color = "Year",
       linetype = "Income category") + 
  scale_color_manual(values = c("#bdb8ad","#44749D")) +
  scale_linetype_manual(values = c("Below poverty line" = "dashed", "Above poverty line" = "solid")) +
  theme_bw()+
  theme(panel.grid.major=element_line(color="grey93"),
        panel.grid.minor=element_line(color="grey93")) +
  scale_x_continuous(limits = c(0,400), expand=c(0,0)) +
  ylim(0.965,1)
```


